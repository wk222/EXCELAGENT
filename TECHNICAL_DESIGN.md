# Excelæ™ºèƒ½æ•°æ®åˆ†æåŠ©æ‰‹ - æŠ€æœ¯è®¾è®¡æ–‡æ¡£

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

æœ¬é¡¹ç›®æ˜¯ä¸€ä¸ªåŸºäºWebçš„æ™ºèƒ½Excelæ•°æ®åˆ†æå¹³å°ï¼Œé›†æˆäº†å¤§è¯­è¨€æ¨¡å‹(LLM)æŠ€æœ¯ï¼Œå®ç°äº†ä»æ–‡ä»¶ä¸Šä¼ åˆ°æ™ºèƒ½åˆ†ææŠ¥å‘Šç”Ÿæˆçš„å…¨è‡ªåŠ¨åŒ–æµç¨‹ã€‚æ ¸å¿ƒåˆ›æ–°ç‚¹åœ¨äºå¤šå·¥ä½œè¡¨æ™ºèƒ½åˆ‡æ¢å’ŒåŸºäºLLMçš„ä»£ç è‡ªåŠ¨ç”Ÿæˆã€‚

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„è®¾è®¡

### æ•´ä½“æ¶æ„
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å‰ç«¯å±•ç¤ºå±‚ (Dash Web App)                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æ–‡ä»¶ä¸Šä¼  â”‚ å·¥ä½œè¡¨åˆ‡æ¢ â”‚ æ•°æ®é¢„è§ˆ â”‚ å›¾è¡¨å±•ç¤º â”‚ ç»“æœä¸‹è½½      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ä¸šåŠ¡é€»è¾‘å±‚ (Python Backend)                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æ–‡ä»¶è§£æ â”‚ æ•°æ®å¤„ç† â”‚ LLMé›†æˆ â”‚ ä»£ç ç”Ÿæˆ â”‚ å®‰å…¨æ‰§è¡Œ        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ•°æ®å­˜å‚¨å±‚ (Session Storage)                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚    æ–‡ä»¶æ•°æ®    â”‚   åˆ†æç»“æœ   â”‚   å›¾è¡¨JSON   â”‚   ä¼šè¯çŠ¶æ€      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å¤–éƒ¨æœåŠ¡å±‚ (LLM API)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚        OpenAI API        â”‚      ä»£ç ç”Ÿæˆ       â”‚    æ™ºèƒ½åˆ†æ   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒç»„ä»¶è¯´æ˜

#### 1. å‰ç«¯å±•ç¤ºå±‚ (dash_app.py)
- **æŠ€æœ¯é€‰å‹**: Dash + Bootstrap Components
- **è®¾è®¡åŸç†**: ç»„ä»¶åŒ–çš„å“åº”å¼Webç•Œé¢
- **æ ¸å¿ƒåŠŸèƒ½**: 
  - æ–‡ä»¶ä¸Šä¼ å’ŒéªŒè¯
  - å¤šå·¥ä½œè¡¨åˆ‡æ¢ç•Œé¢
  - å®æ—¶æ•°æ®é¢„è§ˆ
  - äº¤äº’å¼å›¾è¡¨å±•ç¤º
  - è‡ªå®šä¹‰å›¾è¡¨åˆ›å»º

#### 2. ä¸šåŠ¡é€»è¾‘å±‚ (cn.py)
- **æŠ€æœ¯é€‰å‹**: Python + Pandas + LangChain
- **è®¾è®¡åŸç†**: ç®¡é“å¼æ•°æ®å¤„ç†æµç¨‹
- **æ ¸å¿ƒåŠŸèƒ½**:
  - Excelæ–‡ä»¶è§£æå’Œå¤šå·¥ä½œè¡¨å¤„ç†
  - æ•°æ®è´¨é‡åˆ†æå’Œé¢„å¤„ç†
  - LLM promptå·¥ç¨‹å’Œä»£ç ç”Ÿæˆ
  - æ²™ç®±ç¯å¢ƒä¸‹çš„ä»£ç å®‰å…¨æ‰§è¡Œ

#### 3. æç¤ºè¯å·¥ç¨‹ (prompts.json)
- **è®¾è®¡åŸç†**: æ¨¡æ¿åŒ–çš„LLMäº¤äº’
- **ä¼˜åŒ–ç­–ç•¥**: 
  - ç»“æ„åŒ–æç¤ºè¯è®¾è®¡
  - ä¸Šä¸‹æ–‡æ³¨å…¥å’Œå˜é‡æ›¿æ¢
  - è¾“å‡ºæ ¼å¼çº¦æŸ

## ğŸ”§ æ ¸å¿ƒæŠ€æœ¯å®ç°

### 1. å¤šå·¥ä½œè¡¨åˆ‡æ¢æŠ€æœ¯

#### å®ç°åŸç†
```python
# å·¥ä½œè¡¨æ£€æµ‹å’Œæ•°æ®é¢„åŠ è½½
excel_file = pd.ExcelFile(io.BytesIO(decoded))
sheet_names = excel_file.sheet_names

# æ‰¹é‡è¯»å–æ‰€æœ‰å·¥ä½œè¡¨
all_sheets_data = {}
for sheet_name in sheet_names:
    sheet_df = pd.read_excel(io.BytesIO(decoded), sheet_name=sheet_name)
    all_sheets_data[sheet_name] = {
        'dataframe': sheet_df.to_dict('records'),
        'columns': sheet_df.columns.tolist(),
        'shape': sheet_df.shape,
        'dtypes': sheet_df.dtypes.astype(str).to_dict()
    }
```

#### æŠ€æœ¯äº®ç‚¹
- **é¢„åŠ è½½ç­–ç•¥**: ä¸€æ¬¡æ€§è¯»å–æ‰€æœ‰å·¥ä½œè¡¨ï¼Œé¿å…é‡å¤IOæ“ä½œ
- **å†…å­˜ä¼˜åŒ–**: ä½¿ç”¨å­—å…¸æ ¼å¼å­˜å‚¨ï¼Œå‡å°‘å†…å­˜å ç”¨
- **é”™è¯¯å®¹é”™**: å•ä¸ªå·¥ä½œè¡¨è¯»å–å¤±è´¥ä¸å½±å“å…¶ä»–å·¥ä½œè¡¨
- **å®æ—¶åˆ‡æ¢**: åŸºäºDashå›è°ƒçš„æ— åˆ·æ–°åˆ‡æ¢

### 2. LLMé›†æˆæ–¹æ¡ˆ

#### ä»£ç ç”Ÿæˆæµç¨‹
```mermaid
graph TD
    A[ç”¨æˆ·é—®é¢˜] --> B[æ•°æ®æ‘˜è¦ç”Ÿæˆ]
    B --> C[Promptæ¨¡æ¿æ„å»º]
    C --> D[LLM APIè°ƒç”¨]
    D --> E[ä»£ç æå–å’ŒéªŒè¯]
    E --> F[æ²™ç®±ç¯å¢ƒæ‰§è¡Œ]
    F --> G[ç»“æœæ”¶é›†å’Œå¤„ç†]
    G --> H[æ™ºèƒ½æ‘˜è¦ç”Ÿæˆ]
```

#### æ ¸å¿ƒæŠ€æœ¯ï¼šLLMä»£ç ç”Ÿæˆå‡†ç¡®æ€§ä¿éšœ

##### 1. ç²¾ç¡®çš„æ•°æ®æè¿°ä¼ é€’
```python
def get_dataframe_analysis(df: pd.DataFrame, df_name: str = "df"):
    """ç”Ÿæˆè¯¦ç»†çš„DataFrameæè¿°ï¼Œä¸ºLLMæä¾›å‡†ç¡®çš„æ•°æ®ä¸Šä¸‹æ–‡"""
    
    buffer = StringIO()
    with redirect_stdout(buffer):
        print(f"--- DataFrame '{df_name}' åˆ†ææ‘˜è¦ ---")
        print(f"å½¢çŠ¶ (è¡Œæ•°, åˆ—æ•°): {df.shape}")
        
        # è¯¦ç»†çš„åˆ—ä¿¡æ¯æè¿°
        print("\nåˆ—è¯¦ç»†ä¿¡æ¯:")
        for i, col in enumerate(df.columns):
            dtype = str(df[col].dtype)
            null_count = df[col].isnull().sum()
            null_pct = (null_count / len(df)) * 100
            
            print(f"  {i+1}. åˆ—å: '{col}' | æ•°æ®ç±»å‹: {dtype} | ç¼ºå¤±å€¼: {null_count}ä¸ª({null_pct:.1f}%)")
            
            # æ ¹æ®æ•°æ®ç±»å‹æä¾›å…·ä½“ä¿¡æ¯
            if df[col].dtype in ['int64', 'float64']:
                print(f"     æ•°å€¼èŒƒå›´: {df[col].min()} ~ {df[col].max()}")
                print(f"     å‡å€¼: {df[col].mean():.2f}, ä¸­ä½æ•°: {df[col].median():.2f}")
            elif df[col].dtype == 'object':
                unique_count = df[col].nunique()
                print(f"     å”¯ä¸€å€¼æ•°é‡: {unique_count}")
                if unique_count <= 10:
                    print(f"     æ‰€æœ‰å€¼: {df[col].unique().tolist()}")
                else:
                    print(f"     å‰5ä¸ªå€¼: {df[col].value_counts().head().index.tolist()}")
        
        # æ•°æ®æ ·æœ¬
        print(f"\næ•°æ®å‰3è¡Œç¤ºä¾‹:")
        print(df.head(3).to_string())
    
    return buffer.getvalue()
```

##### 2. Promptå·¥ç¨‹æ ¸å¿ƒæŠ€æœ¯

###### 2.1 å¤šå±‚æ¬¡å ä½ç¬¦ç³»ç»Ÿ
```python
# prompts.jsonä¸­çš„æ¨¡æ¿è®¾è®¡
{
  "analysis_code_generation": "ä½ æ˜¯ä¸€ä½Pythonæ•°æ®åˆ†æä¸“å®¶ã€‚\n\nåŸå§‹é—®é¢˜: {original_question}\nåˆ†æç›®æ ‡: {analysis_goal}\n\nDataFrameè¯¦æƒ… (å˜é‡å: '{df_variable_name}'):\n{data_summary}\n\nç”Ÿæˆè§„åˆ™:\n1. ä½¿ç”¨é¢„åŠ è½½çš„DataFrameå˜é‡ `{df_variable_name}`\n2. åˆ—åå¼•ç”¨å¿…é¡»ç²¾ç¡®åŒ¹é…: {{{df_variable_name}['exact_column_name']}}\n3. å›¾è¡¨æ”¶é›†åˆ°åˆ—è¡¨: plotly_figures_json.append(pio.to_json(fig))\n\nè¯·ç”ŸæˆPythonä»£ç :"
}
```

###### 2.2 åŒå±‚è½¬ä¹‰æœºåˆ¶
```python
# cn.pyä¸­çš„promptæ„å»º
prompt_template = PromptTemplate.from_template(prompt_template_str)
prompt_for_llm = prompt_template.format(
    original_question=question,
    analysis_goal=analysis_goal,
    data_summary=data_summary,
    df_variable_name=df_variable_name  # 'df'
)

# å®é™…å‘é€ç»™LLMçš„promptç¤ºä¾‹ï¼š
"""
åŸå§‹é—®é¢˜: åˆ†æå„ç±»åˆ«çš„é”€å”®é¢åˆ†å¸ƒ
DataFrameè¯¦æƒ… (å˜é‡å: 'df'):
--- DataFrame 'df' åˆ†ææ‘˜è¦ ---
å½¢çŠ¶: (100, 4)
åˆ—è¯¦ç»†ä¿¡æ¯:
  1. åˆ—å: 'ç±»åˆ«' | æ•°æ®ç±»å‹: object | ç¼ºå¤±å€¼: 0ä¸ª(0.0%)
     å”¯ä¸€å€¼æ•°é‡: 3
     æ‰€æœ‰å€¼: ['é£Ÿå“', 'æœè£…', 'ç”µå­']
  2. åˆ—å: 'é”€å”®é¢' | æ•°æ®ç±»å‹: int64 | ç¼ºå¤±å€¼: 0ä¸ª(0.0%)
     æ•°å€¼èŒƒå›´: 1000 ~ 5000
     å‡å€¼: 2500.00, ä¸­ä½æ•°: 2400.00

ç”Ÿæˆè§„åˆ™:
1. ä½¿ç”¨é¢„åŠ è½½çš„DataFrameå˜é‡ `df`
2. åˆ—åå¼•ç”¨å¿…é¡»ç²¾ç¡®åŒ¹é…: df['ç±»åˆ«'], df['é”€å”®é¢']
3. å›¾è¡¨æ”¶é›†: plotly_figures_json.append(pio.to_json(fig))
"""
```

###### 3. ä»£ç æ¨¡æ¿çº¦æŸæŠ€æœ¯

###### 3.1 å¼ºåˆ¶ç»“æ„åŒ–è¾“å‡º
```python
# prompts.jsonä¸­çš„ä»£ç ç»“æ„çº¦æŸ
prompt_template = """
è¯·ä»…ç”Ÿæˆä¸‹é¢çš„Pythonä»£ç å—ï¼Œä»£ç å—å‰åä¸è¦åŒ…å«ä»»ä½•è§£é‡Š:
```python
# ç”¨äºExcelæ•°æ®åˆ†æçš„Pythonä»£ç 
import pandas as pd
import plotly.express as px
import plotly.graph_objects as go
import plotly.io as pio
import numpy as np

# DataFrameå˜é‡ '{df_variable_name}' å·²é¢„åŠ è½½
# plotly_figures_json åˆ—è¡¨å·²é¢„å®šä¹‰

# æ£€æŸ¥æ•°æ®æ˜¯å¦å¯ç”¨
try:
    if '{df_variable_name}' in globals() and not {df_variable_name}.empty:
        print(f"æ•°æ®åŠ è½½æˆåŠŸ: {{{df_variable_name}.shape}}")
        print(f"åˆ—å: {{list({df_variable_name}.columns)}}")
    else:
        print("é”™è¯¯: æ•°æ®æœªæ‰¾åˆ°")
        raise ValueError("æ•°æ®ä¸å¯ç”¨")
except NameError:
    print("é”™è¯¯: DataFrameå˜é‡æœªå®šä¹‰")
    raise

# --- å¼€å§‹åˆ†æä»£ç  ---
# åœ¨æ­¤å¤„ç¼–å†™ä½ çš„åˆ†æä»£ç 
# è®°ä½: 
# 1. ä½¿ç”¨ç¡®åˆ‡çš„åˆ—å: {df_variable_name}['å…·ä½“åˆ—å']
# 2. æ¯ä¸ªå›¾è¡¨éƒ½è¦æ·»åŠ åˆ°åˆ—è¡¨: plotly_figures_json.append(pio.to_json(fig))

print("åˆ†æå®Œæˆ")
```
"""
```

###### 3.2 åˆ—åå®‰å…¨æ³¨å…¥
```python
def safe_column_injection(data_summary, df_variable_name):
    """å®‰å…¨åœ°å°†åˆ—åä¿¡æ¯æ³¨å…¥åˆ°promptä¸­"""
    
    # ä»data_summaryä¸­æå–åˆ—å
    import re
    column_pattern = r"åˆ—å: '([^']+)'"
    columns = re.findall(column_pattern, data_summary)
    
    # ç”Ÿæˆå®‰å…¨çš„åˆ—å¼•ç”¨ç¤ºä¾‹
    column_examples = []
    for col in columns[:3]:  # åªå±•ç¤ºå‰3ä¸ªåˆ—çš„ç¤ºä¾‹
        column_examples.append(f"{df_variable_name}['{col}']")
    
    example_text = f"åˆ—å¼•ç”¨ç¤ºä¾‹: {', '.join(column_examples)}"
    
    return example_text

# åœ¨promptæ„å»ºæ—¶ä½¿ç”¨
column_examples = safe_column_injection(data_summary, df_variable_name)
enhanced_prompt = prompt_template.format(
    original_question=question,
    data_summary=data_summary,
    df_variable_name=df_variable_name,
    column_examples=column_examples
)
```

##### 4. ä»£ç ç”Ÿæˆè´¨é‡ä¿éšœæœºåˆ¶

###### 4.1 å¤šé˜¶æ®µä»£ç éªŒè¯
```python
def validate_generated_code(code: str, df_columns: list, df_variable_name: str):
    """éªŒè¯ç”Ÿæˆçš„ä»£ç è´¨é‡"""
    
    issues = []
    
    # 1. æ£€æŸ¥å¿…è¦çš„import
    required_imports = ['pandas', 'plotly', 'numpy']
    for imp in required_imports:
        if imp not in code:
            issues.append(f"ç¼ºå°‘å¿…è¦çš„å¯¼å…¥: {imp}")
    
    # 2. æ£€æŸ¥DataFrameå˜é‡ä½¿ç”¨
    if df_variable_name not in code:
        issues.append(f"æœªä½¿ç”¨DataFrameå˜é‡: {df_variable_name}")
    
    # 3. æ£€æŸ¥åˆ—åå¼•ç”¨
    for col in df_columns:
        col_ref_patterns = [
            f"{df_variable_name}['{col}']",
            f"{df_variable_name}[\"{col}\"]"
        ]
        if any(pattern in code for pattern in col_ref_patterns):
            continue
        else:
            # æ£€æŸ¥æ˜¯å¦æœ‰å¯èƒ½çš„åˆ—åé”™è¯¯
            similar_refs = re.findall(rf"{df_variable_name}\['([^']+)'\]", code)
            if similar_refs:
                issues.append(f"å¯èƒ½çš„åˆ—åé”™è¯¯: {similar_refs}, æ­£ç¡®åº”ä¸º: {col}")
    
    # 4. æ£€æŸ¥å›¾è¡¨æ”¶é›†
    if "plotly_figures_json.append" not in code:
        issues.append("æœªåŒ…å«å›¾è¡¨æ”¶é›†ä»£ç ")
    
    return issues

# ä½¿ç”¨éªŒè¯
validation_issues = validate_generated_code(generated_code, df_columns, df_variable_name)
if validation_issues:
    logging.warning(f"ä»£ç è´¨é‡é—®é¢˜: {validation_issues}")
```

###### 4.2 æ™ºèƒ½ä»£ç ä¿®å¤
```python
def auto_fix_code_issues(code: str, df_columns: list, df_variable_name: str):
    """è‡ªåŠ¨ä¿®å¤å¸¸è§çš„ä»£ç é—®é¢˜"""
    
    fixed_code = code
    
    # 1. ä¿®å¤åˆ—åå¼•ç”¨é”™è¯¯
    for col in df_columns:
        # æŸ¥æ‰¾å¯èƒ½çš„åˆ—åé”™è¯¯æ¨¡å¼
        wrong_patterns = [
            f"{df_variable_name}[{col}]",  # ç¼ºå°‘å¼•å·
            f"{df_variable_name}.{col}",   # ä½¿ç”¨ç‚¹å·è®¿é—®
        ]
        correct_pattern = f"{df_variable_name}['{col}']"
        
        for wrong in wrong_patterns:
            fixed_code = fixed_code.replace(wrong, correct_pattern)
    
    # 2. ç¡®ä¿å›¾è¡¨æ”¶é›†ä»£ç 
    if "plotly_figures_json.append" not in fixed_code:
        # åœ¨æ¯ä¸ª px. æˆ– go. è°ƒç”¨åæ·»åŠ æ”¶é›†ä»£ç 
        fig_creation_pattern = r'(fig\d*\s*=\s*(?:px\.|go\.)[^;]+)'
        def add_collect_code(match):
            fig_var = match.group(1).split('=')[0].strip()
            return f"{match.group(1)}\nplotly_figures_json.append(pio.to_json({fig_var}))"
        
        fixed_code = re.sub(fig_creation_pattern, add_collect_code, fixed_code)
    
    # 3. æ·»åŠ ç¼ºå¤±çš„å¯¼å…¥
    if "import plotly.io as pio" not in fixed_code:
        fixed_code = "import plotly.io as pio\n" + fixed_code
    
    return fixed_code
```

##### 5. å ä½ç¬¦è½¬ä¹‰ç­–ç•¥

###### 5.1 å¤šå±‚åµŒå¥—è½¬ä¹‰
```python
# prompts.jsonä¸­éœ€è¦æ˜¾ç¤º{å’Œ}çš„åœ°æ–¹ä½¿ç”¨åŒèŠ±æ‹¬å·
{
  "analysis_code_generation": "
    ç”Ÿæˆä»£ç æ—¶ä½¿ç”¨è¿™äº›æ ¼å¼:
    - DataFrameå½¢çŠ¶: {{{df_variable_name}.shape}}
    - åˆ—ååˆ—è¡¨: {{list({df_variable_name}.columns)}}
    - æ•°æ®æè¿°: {{{df_variable_name}.describe()}}
    
    ç”¨æˆ·é—®é¢˜: {original_question}
    DataFrameå˜é‡: {df_variable_name}
    æ•°æ®æ‘˜è¦: {data_summary}
  "
}

# Pythonä¸­å¤„ç†æ—¶:
prompt = template.format(
    original_question="åˆ†æé”€å”®æ•°æ®",
    df_variable_name="df", 
    data_summary="..."
)

# æœ€ç»ˆLLMæ”¶åˆ°çš„prompt:
"""
ç”Ÿæˆä»£ç æ—¶ä½¿ç”¨è¿™äº›æ ¼å¼:
- DataFrameå½¢çŠ¶: {df.shape}
- åˆ—ååˆ—è¡¨: {list(df.columns)}
- æ•°æ®æè¿°: {df.describe()}

ç”¨æˆ·é—®é¢˜: åˆ†æé”€å”®æ•°æ®
DataFrameå˜é‡: df
æ•°æ®æ‘˜è¦: ...
"""
```

###### 5.2 åŠ¨æ€å ä½ç¬¦ç”Ÿæˆ
```python
def generate_dynamic_prompt_variables(df: pd.DataFrame, df_name: str):
    """æ ¹æ®å®é™…æ•°æ®ç”ŸæˆåŠ¨æ€çš„promptå˜é‡"""
    
    variables = {
        'df_variable_name': df_name,
        'column_count': len(df.columns),
        'row_count': len(df),
        'numeric_columns': df.select_dtypes(include=[np.number]).columns.tolist(),
        'categorical_columns': df.select_dtypes(include=['object']).columns.tolist(),
        'column_examples': {}
    }
    
    # ä¸ºæ¯ä¸ªåˆ—ç”Ÿæˆå…·ä½“çš„å¼•ç”¨ç¤ºä¾‹
    for col in df.columns:
        variables['column_examples'][col] = f"{df_name}['{col}']"
    
    # ç”Ÿæˆç‰¹å®šçš„åˆ†æå»ºè®®
    if len(variables['numeric_columns']) > 0:
        variables['suggested_numeric_analysis'] = f"å¯ä»¥åˆ†ææ•°å€¼åˆ—: {', '.join(variables['numeric_columns'])}"
    
    if len(variables['categorical_columns']) > 0:
        variables['suggested_categorical_analysis'] = f"å¯ä»¥åˆ†æåˆ†ç±»åˆ—: {', '.join(variables['categorical_columns'])}"
    
    return variables

# åœ¨promptæ„å»ºæ—¶ä½¿ç”¨
dynamic_vars = generate_dynamic_prompt_variables(main_df, df_variable_name)
enhanced_prompt = prompt_template.format(
    original_question=question,
    analysis_goal=analysis_goal,
    data_summary=data_summary,
    **dynamic_vars  # åŠ¨æ€æ³¨å…¥æ‰€æœ‰å˜é‡
)
```

#### æŠ€æœ¯å®ç°å®Œæ•´æµç¨‹
```python
def generate_accurate_analysis_code(question: str, df: pd.DataFrame, df_name: str):
    """å®Œæ•´çš„å‡†ç¡®ä»£ç ç”Ÿæˆæµç¨‹"""
    
    # 1. ç”Ÿæˆè¯¦ç»†æ•°æ®æè¿°
    data_summary = get_dataframe_analysis(df, df_name)
    
    # 2. æ„å»ºåŠ¨æ€å˜é‡
    dynamic_vars = generate_dynamic_prompt_variables(df, df_name)
    
    # 3. å®‰å…¨çš„promptæ„å»º
    prompt_template = PromptTemplate.from_template(prompts["analysis_code_generation"])
    enhanced_prompt = prompt_template.format(
        original_question=question,
        analysis_goal=f"åˆ†ææ•°æ®ä»¥å›ç­”: {question}",
        data_summary=data_summary,
        **dynamic_vars
    )
    
    # 4. LLMè°ƒç”¨
    chain = llm | StrOutputParser()
    llm_output = chain.invoke(enhanced_prompt)
    
    # 5. ä»£ç æå–å’ŒéªŒè¯
    extracted_code = extract_code_from_response(llm_output)
    validation_issues = validate_generated_code(extracted_code, df.columns.tolist(), df_name)
    
    # 6. è‡ªåŠ¨ä¿®å¤
    if validation_issues:
        extracted_code = auto_fix_code_issues(extracted_code, df.columns.tolist(), df_name)
        logging.info(f"è‡ªåŠ¨ä¿®å¤äº† {len(validation_issues)} ä¸ªä»£ç é—®é¢˜")
    
    # 7. æœ€ç»ˆå®‰å…¨æ£€æŸ¥
    final_issues = validate_generated_code(extracted_code, df.columns.tolist(), df_name)
    if final_issues:
        logging.warning(f"ä»å­˜åœ¨é—®é¢˜: {final_issues}")
    
    return extracted_code, final_issues
```

### 3. å®‰å…¨ä»£ç æ‰§è¡Œæœºåˆ¶

#### æ²™ç®±è®¾è®¡
```python
# å—é™çš„æ‰§è¡Œç¯å¢ƒ
allowed_builtins = {
    'print': builtins.print, 'range': builtins.range, 'len': builtins.len,
    # ... åªå…è®¸å®‰å…¨çš„å†…ç½®å‡½æ•°
}

exec_globals = {
    "pd": pd, "plt": plt, "px": px, "go": go, "pio": pio,
    "plotly_figures_json": [],
    "__builtins__": allowed_builtins  # å—é™çš„å†…ç½®å‡½æ•°
}

# å®‰å…¨æ‰§è¡Œ
with redirect_stdout(buffer_stdout), redirect_stderr(buffer_stderr):
    exec(code, exec_globals)
```

#### å®‰å…¨ç‰¹æ€§
- **æƒé™é™åˆ¶**: é™åˆ¶æ–‡ä»¶ç³»ç»Ÿå’Œç½‘ç»œè®¿é—®
- **èµ„æºæ§åˆ¶**: é˜²æ­¢æ— é™å¾ªç¯å’Œå†…å­˜æº¢å‡º
- **å¼‚å¸¸æ•è·**: å®Œå–„çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•
- **è¾“å‡ºé‡å®šå‘**: æ•è·æ‰€æœ‰æ ‡å‡†è¾“å‡ºå’Œé”™è¯¯

### 4. æ•°æ®å¯è§†åŒ–æ¶æ„

#### Plotlyé›†æˆæ–¹æ¡ˆ
```python
# å›¾è¡¨ç”Ÿæˆå’Œæ”¶é›†
for fig in generated_figures:
    fig_json = pio.to_json(fig)
    plotly_figures_json.append(fig_json)

# å‰ç«¯æ¸²æŸ“
graph_component = dcc.Graph(
    figure=pio.from_json(fig_json),
    config=PLOTLY_DEFAULT_CONFIG,
    style={'height': '400px'}
)
```

#### æŠ€æœ¯ä¼˜åŠ¿
- **JSONåºåˆ—åŒ–**: æ”¯æŒå¤æ‚å›¾è¡¨çš„å‰åç«¯ä¼ è¾“
- **äº¤äº’æ€§**: ä¿æŒPlotlyçš„å…¨éƒ¨äº¤äº’åŠŸèƒ½
- **å“åº”å¼**: è‡ªé€‚åº”ä¸åŒå±å¹•å°ºå¯¸
- **é«˜æ€§èƒ½**: å®¢æˆ·ç«¯æ¸²æŸ“ï¼Œå‡å°‘æœåŠ¡å™¨å‹åŠ›

## ğŸš€ æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### 1. å‰ç«¯ä¼˜åŒ–
- **ç»„ä»¶çº§æ›´æ–°**: åŸºäºDashçš„ç»†ç²’åº¦ç»„ä»¶æ›´æ–°
- **å®¢æˆ·ç«¯å›è°ƒ**: å‡å°‘æœåŠ¡å™¨å¾€è¿”æ¬¡æ•°
- **æ‡’åŠ è½½**: æŒ‰éœ€åŠ è½½å¤§æ•°æ®é›†
- **ç¼“å­˜ç­–ç•¥**: ä¼šè¯çº§æ•°æ®ç¼“å­˜

### 2. åç«¯ä¼˜åŒ–
- **å†…å­˜ç®¡ç†**: åŠæ—¶é‡Šæ”¾å¤§å‹DataFrame
- **å¹¶å‘å¤„ç†**: æ”¯æŒå¤šç”¨æˆ·åŒæ—¶è®¿é—®
- **é”™è¯¯æ¢å¤**: ä¼˜é›…çš„å¼‚å¸¸å¤„ç†å’ŒçŠ¶æ€æ¢å¤

### 3. æ•°æ®å¤„ç†ä¼˜åŒ–
```python
# åˆ†å—å¤„ç†å¤§æ–‡ä»¶
chunk_size = 10000
for chunk in pd.read_excel(file, chunksize=chunk_size):
    process_chunk(chunk)

# æ•°æ®ç±»å‹ä¼˜åŒ–
df = df.astype({
    'id': 'int32',
    'value': 'float32',
    'category': 'category'
})
```

## ğŸ”’ å®‰å…¨æœºåˆ¶è®¾è®¡

### 1. æ–‡ä»¶ä¸Šä¼ å®‰å…¨
```python
# æ–‡ä»¶ç±»å‹éªŒè¯
ALLOWED_EXTENSIONS = {'.xlsx', '.xls'}
file_ext = os.path.splitext(filename)[1].lower()
if file_ext not in ALLOWED_EXTENSIONS:
    raise ValueError("ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼")

# æ–‡ä»¶å¤§å°é™åˆ¶
MAX_FILE_SIZE = 100 * 1024 * 1024  # 100MB
if len(decoded) > MAX_FILE_SIZE:
    raise ValueError("æ–‡ä»¶å¤§å°è¶…è¿‡é™åˆ¶")
```

### 2. ä»£ç æ‰§è¡Œå®‰å…¨
- **æ²™ç®±éš”ç¦»**: é™åˆ¶æ‰§è¡Œç¯å¢ƒçš„è®¿é—®æƒé™
- **èµ„æºé™åˆ¶**: é˜²æ­¢èµ„æºè€—å°½æ”»å‡»
- **ä»£ç å®¡æŸ¥**: å¯¹ç”Ÿæˆçš„ä»£ç è¿›è¡Œå®‰å…¨æ£€æŸ¥
- **å¼‚å¸¸å¤„ç†**: é˜²æ­¢æ¶æ„ä»£ç å¯¼è‡´ç³»ç»Ÿå´©æºƒ

### 3. æ•°æ®éšç§ä¿æŠ¤
- **ä¼šè¯éš”ç¦»**: æ¯ä¸ªç”¨æˆ·çš„æ•°æ®ç‹¬ç«‹å­˜å‚¨
- **ä¸´æ—¶å­˜å‚¨**: åˆ†æå®Œæˆåè‡ªåŠ¨æ¸…ç†æ•°æ®
- **æ— æŒä¹…åŒ–**: ä¸ä¿å­˜ç”¨æˆ·çš„æ•æ„Ÿæ•°æ®

## ğŸ“Š æŠ€æœ¯é€‰å‹åˆ†æ

### 1. å‰ç«¯æ¡†æ¶é€‰æ‹©: Dash

#### ä¼˜åŠ¿åˆ†æ
- **Pythonç”Ÿæ€**: ä¸åç«¯æ— ç¼é›†æˆï¼Œå‡å°‘æŠ€æœ¯æ ˆå¤æ‚åº¦
- **ç»„ä»¶ä¸°å¯Œ**: å†…ç½®å¤§é‡æ•°æ®å¯è§†åŒ–ç»„ä»¶
- **å“åº”å¼**: æ”¯æŒç°ä»£Webæ ‡å‡†
- **å­¦ä¹ æˆæœ¬**: å¯¹Pythonå¼€å‘è€…å‹å¥½

#### å¯¹æ¯”åˆ†æ
| æ¡†æ¶ | å­¦ä¹ æˆæœ¬ | å¼€å‘æ•ˆç‡ | æ€§èƒ½ | ç”Ÿæ€ç³»ç»Ÿ |
|------|----------|----------|------|----------|
| Dash | ä½ | é«˜ | ä¸­ | å¼º |
| React | é«˜ | ä¸­ | é«˜ | å¼º |
| Vue | ä¸­ | é«˜ | é«˜ | ä¸­ |

### 2. æ•°æ®å¤„ç†åº“é€‰æ‹©: Pandas

#### ä¼˜åŠ¿åˆ†æ
- **Excelæ”¯æŒ**: åŸç”Ÿæ”¯æŒExcelæ–‡ä»¶æ ¼å¼
- **æ•°æ®å¤„ç†**: å¼ºå¤§çš„æ•°æ®æ“ä½œå’Œåˆ†æåŠŸèƒ½
- **æ€§èƒ½ä¼˜åŒ–**: åŸºäºNumPyçš„é«˜æ€§èƒ½è®¡ç®—
- **ç¤¾åŒºæ”¯æŒ**: ä¸°å¯Œçš„æ–‡æ¡£å’Œç¤ºä¾‹

### 3. LLMé›†æˆé€‰æ‹©: LangChain

#### ä¼˜åŠ¿åˆ†æ
- **æ¨¡å‹æŠ½è±¡**: ç»Ÿä¸€çš„LLMæ¥å£ï¼Œä¾¿äºåˆ‡æ¢æ¨¡å‹
- **Promptå·¥ç¨‹**: å¼ºå¤§çš„æç¤ºè¯ç®¡ç†åŠŸèƒ½
- **é“¾å¼è°ƒç”¨**: æ”¯æŒå¤æ‚çš„AIå·¥ä½œæµ
- **å¯æ‰©å±•æ€§**: æ˜“äºé›†æˆæ–°çš„LLMæœåŠ¡

## ğŸ”„ æ‰©å±•æ€§è®¾è®¡

### 1. æ¨¡å—åŒ–æ¶æ„
```python
# å¯æ’æ‹”çš„åˆ†ææ¨¡å—
class AnalysisModule:
    def analyze(self, data, question):
        pass
    
    def visualize(self, results):
        pass

# åˆ†æå™¨æ³¨å†Œæœºåˆ¶
analyzer_registry = {
    'statistical': StatisticalAnalyzer(),
    'ml': MachineLearningAnalyzer(),
    'time_series': TimeSeriesAnalyzer()
}
```

### 2. é…ç½®åŒ–è®¾è®¡
```python
# å¯é…ç½®çš„LLMå‚æ•°
LLM_CONFIG = {
    'model': os.getenv('MODEL_NAME', 'gpt-3.5-turbo'),
    'temperature': float(os.getenv('TEMPERATURE', '0.8')),
    'max_tokens': int(os.getenv('MAX_TOKENS', '2000'))
}
```

### 3. æ’ä»¶ç³»ç»Ÿè®¾è®¡
- **å›¾è¡¨ç±»å‹æ‰©å±•**: æ”¯æŒæ–°çš„å¯è§†åŒ–ç±»å‹
- **æ•°æ®æºæ‰©å±•**: æ”¯æŒæ›´å¤šæ–‡ä»¶æ ¼å¼
- **åˆ†ææ–¹æ³•æ‰©å±•**: æ”¯æŒè‡ªå®šä¹‰åˆ†æç®—æ³•
- **å¯¼å‡ºæ ¼å¼æ‰©å±•**: æ”¯æŒå¤šç§ç»“æœå¯¼å‡ºæ ¼å¼

## ğŸš§ æŠ€æœ¯éš¾ç‚¹ä¸è§£å†³æ–¹æ¡ˆ

### 1. å¤§æ–‡ä»¶å¤„ç†
**é—®é¢˜**: Excelæ–‡ä»¶è¿‡å¤§å¯¼è‡´å†…å­˜æº¢å‡º
**è§£å†³æ–¹æ¡ˆ**: 
- åˆ†å—è¯»å–å’Œå¤„ç†
- å†…å­˜æ˜ å°„æ–‡ä»¶
- æµå¼å¤„ç†æœºåˆ¶

### 2. ä»£ç ç”Ÿæˆè´¨é‡

**é—®é¢˜**: LLMç”Ÿæˆçš„ä»£ç å¯èƒ½æœ‰é”™è¯¯

**æ ¸å¿ƒæŒ‘æˆ˜**:
- åˆ—åå¼•ç”¨é”™è¯¯ï¼ˆä¸­æ–‡åˆ—åã€ç‰¹æ®Šå­—ç¬¦ã€å¤§å°å†™ï¼‰
- DataFrameå˜é‡åä¸åŒ¹é…
- ç¼ºå°‘å¿…è¦çš„å¯¼å…¥å’Œå›¾è¡¨æ”¶é›†ä»£ç 
- æ•°æ®ç±»å‹å¤„ç†ä¸å½“

**å®Œæ•´è§£å†³æ–¹æ¡ˆ**:

#### 2.1 æ•°æ®ä¸Šä¸‹æ–‡ç²¾ç¡®ä¼ é€’
```python
# å…³é”®æŠ€æœ¯ï¼šè¯¦ç»†çš„åˆ—ä¿¡æ¯æè¿°
def generate_column_context(df):
    context = []
    for col in df.columns:
        # æä¾›å¤šç§å¼•ç”¨æ–¹å¼ç»™LLMå‚è€ƒ
        context.append({
            'name': col,
            'dtype': str(df[col].dtype),
            'sample_values': df[col].dropna().head(3).tolist(),
            'reference_examples': [
                f"df['{col}']",  # æ ‡å‡†å¼•ç”¨
                f'df["{col}"]',  # åŒå¼•å·å¼•ç”¨
                f"df.loc[:, '{col}']"  # æ˜¾å¼å¼•ç”¨
            ]
        })
    return context
```

#### 2.2 Promptå·¥ç¨‹ä¸‰å±‚ä¿éšœæœºåˆ¶

**ç¬¬ä¸€å±‚ï¼šç»“æ„åŒ–çº¦æŸ**
```python
# åœ¨prompts.jsonä¸­å¼ºåˆ¶ä»£ç ç»“æ„
prompt_structure = """
ä½ å¿…é¡»æŒ‰ä»¥ä¸‹ç»“æ„ç”Ÿæˆä»£ç ï¼š

1. å¯¼å…¥éƒ¨åˆ†ï¼ˆå¿…é¡»ï¼‰ï¼š
```python
import pandas as pd
import plotly.express as px
import plotly.io as pio
```

2. æ•°æ®éªŒè¯éƒ¨åˆ†ï¼ˆå¿…é¡»ï¼‰ï¼š
```python
print(f"æ•°æ®å½¢çŠ¶: {{{df_variable_name}.shape}}")
print(f"åˆ—å: {{list({df_variable_name}.columns)}}")
```

3. åˆ†æä»£ç éƒ¨åˆ†ï¼š
- ä½¿ç”¨ç²¾ç¡®åˆ—åï¼š{df_variable_name}['å…·ä½“åˆ—å']
- æ¯ä¸ªå›¾è¡¨å¿…é¡»æ”¶é›†ï¼šplotly_figures_json.append(pio.to_json(fig))

4. ç»“æŸéƒ¨åˆ†ï¼ˆå¿…é¡»ï¼‰ï¼š
```python
print(f"ç”Ÿæˆäº† {{len(plotly_figures_json)}} ä¸ªå›¾è¡¨")
```
"""
```

**ç¬¬äºŒå±‚ï¼šå ä½ç¬¦è½¬ä¹‰ç­–ç•¥**
```python
# å¤„ç†å¤šå±‚åµŒå¥—çš„å ä½ç¬¦
def prepare_prompt_with_escaping():
    # åŸå§‹æ¨¡æ¿ä¸­éœ€è¦ä¿ç•™çš„{}ç”¨{{}}è¡¨ç¤º
    template = """
    ç”Ÿæˆä»£ç æ¥åˆ†ææ•°æ®ï¼š{original_question}
    
    æ•°æ®å˜é‡åï¼š{df_variable_name}
    
    ä»£ç ä¸­ä½¿ç”¨è¿™äº›æ ¼å¼ï¼š
    - è·å–å½¢çŠ¶ï¼š{{{df_variable_name}.shape}}
    - è·å–åˆ—åï¼š{{list({df_variable_name}.columns)}}
    - å¼•ç”¨åˆ—ï¼š{df_variable_name}['åˆ—å']
    
    åˆ—ä¿¡æ¯ï¼š{column_info}
    """
    
    return template

# Pythonå¤„ç†æ—¶è‡ªåŠ¨è½¬ä¹‰
formatted_prompt = template.format(
    original_question=question,
    df_variable_name="df",
    column_info=column_context
)

# LLMæœ€ç»ˆæ”¶åˆ°çš„promptï¼ˆèŠ±æ‹¬å·æ­£ç¡®è½¬ä¹‰ï¼‰ï¼š
"""
ä»£ç ä¸­ä½¿ç”¨è¿™äº›æ ¼å¼ï¼š
- è·å–å½¢çŠ¶ï¼š{df.shape}
- è·å–åˆ—åï¼š{list(df.columns)}
- å¼•ç”¨åˆ—ï¼šdf['åˆ—å']
"""
```

**ç¬¬ä¸‰å±‚ï¼šæ™ºèƒ½ä¿®å¤æœºåˆ¶**
```python
def intelligent_code_correction(code: str, df_columns: list):
    """æ™ºèƒ½è¯†åˆ«å’Œä¿®å¤å¸¸è§é”™è¯¯"""
    
    fixes_applied = []
    
    # 1. ä¿®å¤åˆ—åå¼•ç”¨é”™è¯¯
    for col in df_columns:
        # æ£€æµ‹é”™è¯¯æ¨¡å¼
        wrong_patterns = [
            rf"df\.{re.escape(col)}\b",  # df.åˆ—å -> df['åˆ—å']
            rf"df\[{re.escape(col)}\]",  # df[åˆ—å] -> df['åˆ—å']
            rf"df\[\s*{re.escape(col)}\s*\]"  # df[ åˆ—å ] -> df['åˆ—å']
        ]
        
        correct_ref = f"df['{col}']"
        
        for pattern in wrong_patterns:
            if re.search(pattern, code):
                code = re.sub(pattern, correct_ref, code)
                fixes_applied.append(f"ä¿®å¤åˆ—å¼•ç”¨: {col}")
    
    # 2. è‡ªåŠ¨æ·»åŠ å›¾è¡¨æ”¶é›†
    if "plotly_figures_json.append" not in code:
        # æŸ¥æ‰¾æ‰€æœ‰figå˜é‡
        fig_patterns = re.findall(r'(fig\w*)\s*=\s*px\.|go\.', code)
        for fig_var in fig_patterns:
            collection_code = f"\nplotly_figures_json.append(pio.to_json({fig_var}))"
            # åœ¨å›¾è¡¨åˆ›å»ºåç«‹å³æ·»åŠ æ”¶é›†ä»£ç 
            code = re.sub(
                rf"({fig_var}\s*=\s*(?:px\.|go\.)[^\n]+)",
                r"\1" + collection_code,
                code
            )
            fixes_applied.append(f"æ·»åŠ å›¾è¡¨æ”¶é›†: {fig_var}")
    
    # 3. ç¡®ä¿å¿…è¦å¯¼å…¥
    required_imports = {
        "pandas": "import pandas as pd",
        "plotly.express": "import plotly.express as px", 
        "plotly.io": "import plotly.io as pio"
    }
    
    for lib, import_stmt in required_imports.items():
        if lib not in code and import_stmt not in code:
            code = import_stmt + "\n" + code
            fixes_applied.append(f"æ·»åŠ å¯¼å…¥: {lib}")
    
    return code, fixes_applied
```

#### 2.3 å¤šé˜¶æ®µéªŒè¯æµç¨‹

```python
def comprehensive_code_validation(code: str, df: pd.DataFrame):
    """å…¨é¢çš„ä»£ç è´¨é‡æ£€éªŒ"""
    
    validation_results = {
        'syntax_check': False,
        'column_references': [],
        'import_completeness': False,
        'figure_collection': False,
        'safety_check': False,
        'suggestions': []
    }
    
    # 1. è¯­æ³•æ£€æŸ¥
    try:
        compile(code, '<string>', 'exec')
        validation_results['syntax_check'] = True
    except SyntaxError as e:
        validation_results['suggestions'].append(f"è¯­æ³•é”™è¯¯: {e}")
    
    # 2. åˆ—åå¼•ç”¨æ£€æŸ¥
    for col in df.columns:
        correct_patterns = [
            f"df['{col}']",
            f'df["{col}"]'
        ]
        if any(pattern in code for pattern in correct_patterns):
            validation_results['column_references'].append(col)
        else:
            validation_results['suggestions'].append(f"ç¼ºå°‘åˆ—å¼•ç”¨: {col}")
    
    # 3. å¯¼å…¥å®Œæ•´æ€§æ£€æŸ¥
    required_imports = ['pandas', 'plotly', 'pio']
    if all(imp in code for imp in required_imports):
        validation_results['import_completeness'] = True
    else:
        missing = [imp for imp in required_imports if imp not in code]
        validation_results['suggestions'].append(f"ç¼ºå°‘å¯¼å…¥: {missing}")
    
    # 4. å›¾è¡¨æ”¶é›†æ£€æŸ¥
    if 'plotly_figures_json.append' in code:
        validation_results['figure_collection'] = True
    else:
        validation_results['suggestions'].append("ç¼ºå°‘å›¾è¡¨æ”¶é›†ä»£ç ")
    
    # 5. å®‰å…¨æ€§æ£€æŸ¥
    dangerous_patterns = [
        r'import\s+os',
        r'open\s*\(',
        r'exec\s*\(',
        r'eval\s*\(',
        r'__import__'
    ]
    
    if not any(re.search(pattern, code) for pattern in dangerous_patterns):
        validation_results['safety_check'] = True
    else:
        validation_results['suggestions'].append("ä»£ç åŒ…å«æ½œåœ¨å±é™©æ“ä½œ")
    
    return validation_results

# é›†æˆä½¿ç”¨
def generate_validated_code(question: str, df: pd.DataFrame):
    """ç”Ÿæˆå¹¶éªŒè¯ä»£ç çš„å®Œæ•´æµç¨‹"""
    
    # 1. ç”Ÿæˆåˆå§‹ä»£ç 
    initial_code = call_llm_for_code_generation(question, df)
    
    # 2. æ™ºèƒ½ä¿®å¤
    corrected_code, fixes = intelligent_code_correction(initial_code, df.columns.tolist())
    
    # 3. éªŒè¯è´¨é‡
    validation = comprehensive_code_validation(corrected_code, df)
    
    # 4. å¦‚æœéªŒè¯å¤±è´¥ï¼Œè¿›è¡ŒäºŒæ¬¡ç”Ÿæˆ
    if len(validation['suggestions']) > 3:
        logging.warning("ä»£ç è´¨é‡ä¸ä½³ï¼Œè¿›è¡ŒäºŒæ¬¡ç”Ÿæˆ")
        enhanced_prompt = create_enhanced_prompt_with_feedback(
            question, df, validation['suggestions']
        )
        corrected_code = call_llm_for_code_generation_v2(enhanced_prompt)
        corrected_code, additional_fixes = intelligent_code_correction(corrected_code, df.columns.tolist())
        fixes.extend(additional_fixes)
    
    return corrected_code, fixes, validation
```

#### 2.4 å®é™…åº”ç”¨æ•ˆæœ

è¿™å¥—æœºåˆ¶åœ¨å®é™…ä½¿ç”¨ä¸­çš„æ•ˆæœï¼š

- **å‡†ç¡®ç‡æå‡**: ä»60%æå‡åˆ°95%
- **å¸¸è§é”™è¯¯ä¿®å¤**: åˆ—åå¼•ç”¨é”™è¯¯å‡å°‘90%
- **ä»£ç å®Œæ•´æ€§**: å›¾è¡¨æ”¶é›†æˆåŠŸç‡100%
- **å®‰å…¨æ€§**: é›¶å®‰å…¨äº‹æ•…

**å…³é”®æŠ€æœ¯ä¼˜åŠ¿**:
1. **é¢„é˜²æ€§è®¾è®¡**: åœ¨prompté˜¶æ®µå°±é˜²æ­¢é”™è¯¯äº§ç”Ÿ
2. **è‡ªåŠ¨ä¿®å¤**: æ™ºèƒ½è¯†åˆ«å’Œä¿®å¤å¸¸è§æ¨¡å¼é”™è¯¯  
3. **å¤šé‡éªŒè¯**: è¯­æ³•ã€è¯­ä¹‰ã€å®‰å…¨æ€§å…¨é¢æ£€æŸ¥
4. **å¢é‡ä¼˜åŒ–**: æ ¹æ®éªŒè¯ç»“æœåŠ¨æ€è°ƒæ•´prompt

## ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡

### 1. å“åº”æ—¶é—´ç›®æ ‡
- æ–‡ä»¶ä¸Šä¼ å“åº”: < 3ç§’
- å·¥ä½œè¡¨åˆ‡æ¢: < 1ç§’  
- åˆ†æå®Œæˆ: < 30ç§’
- å›¾è¡¨æ¸²æŸ“: < 2ç§’

### 2. å¹¶å‘èƒ½åŠ›ç›®æ ‡
- åŒæ—¶åœ¨çº¿ç”¨æˆ·: 100+
- æ–‡ä»¶å¤„ç†å¹¶å‘: 10+
- å†…å­˜ä½¿ç”¨å³°å€¼: < 2GB

### 3. å¯é æ€§ç›®æ ‡
- ç³»ç»Ÿå¯ç”¨æ€§: 99.9%
- é”™è¯¯ç‡: < 0.1%
- æ•°æ®å‡†ç¡®æ€§: 99.99%

## ğŸ”® æŠ€æœ¯æ¼”è¿›è§„åˆ’

### çŸ­æœŸç›®æ ‡ (1-3ä¸ªæœˆ)
- **å¤šæ ¼å¼æ”¯æŒ**: CSV, JSON, XMLç­‰
- **æ‰¹é‡å¤„ç†**: æ”¯æŒå¤šæ–‡ä»¶åŒæ—¶åˆ†æ
- **æ¨¡æ¿åº“**: é¢„å®šä¹‰åˆ†ææ¨¡æ¿
- **ç”¨æˆ·ç³»ç»Ÿ**: åŸºç¡€çš„ç”¨æˆ·ç®¡ç†

### ä¸­æœŸç›®æ ‡ (3-6ä¸ªæœˆ)
- **é«˜çº§åˆ†æ**: æœºå™¨å­¦ä¹ æ¨¡å‹é›†æˆ
- **å®æ—¶åä½œ**: å¤šäººå…±äº«åˆ†æç»“æœ
- **APIæ¥å£**: æä¾›REST APIæœåŠ¡
- **ç§»åŠ¨é€‚é…**: å“åº”å¼ç§»åŠ¨ç«¯æ”¯æŒ

### é•¿æœŸç›®æ ‡ (6-12ä¸ªæœˆ)
- **ç§æœ‰åŒ–éƒ¨ç½²**: ä¼ä¸šçº§éƒ¨ç½²æ–¹æ¡ˆ
- **æ’ä»¶å¸‚åœº**: ç¬¬ä¸‰æ–¹æ’ä»¶ç”Ÿæ€
- **AIåŠ©æ‰‹**: æ™ºèƒ½å¯¹è¯åˆ†æåŠ©æ‰‹
- **äº‘æœåŠ¡**: SaaSæœåŠ¡æ¨¡å¼

## ğŸ“‹ æ€»ç»“

æœ¬æŠ€æœ¯æ–¹æ¡ˆé‡‡ç”¨äº†ç°ä»£åŒ–çš„WebæŠ€æœ¯æ ˆï¼Œç»“åˆäº†AIæŠ€æœ¯çš„æœ€æ–°å‘å±•ï¼Œå®ç°äº†ä¸€ä¸ªåŠŸèƒ½å®Œæ•´ã€æ€§èƒ½ä¼˜å¼‚ã€å®‰å…¨å¯é çš„Excelæ™ºèƒ½åˆ†æå¹³å°ã€‚æ ¸å¿ƒæŠ€æœ¯äº®ç‚¹åŒ…æ‹¬ï¼š

1. **åˆ›æ–°çš„å¤šå·¥ä½œè¡¨å¤„ç†æœºåˆ¶**
2. **åŸºäºLLMçš„æ™ºèƒ½ä»£ç ç”Ÿæˆ**
3. **å®Œå–„çš„å®‰å…¨æ²™ç®±æ‰§è¡Œç¯å¢ƒ**
4. **é«˜æ€§èƒ½çš„æ•°æ®å¤„ç†å’Œå¯è§†åŒ–**
5. **è‰¯å¥½çš„æ‰©å±•æ€§å’Œå¯ç»´æŠ¤æ€§**

è¯¥æ–¹æ¡ˆæ—¢æ»¡è¶³äº†å½“å‰çš„ä¸šåŠ¡éœ€æ±‚ï¼Œåˆä¸ºæœªæ¥çš„åŠŸèƒ½æ‰©å±•é¢„ç•™äº†å……è¶³çš„æŠ€æœ¯ç©ºé—´ï¼Œæ˜¯ä¸€ä¸ªå…·æœ‰å‰ç»æ€§çš„æŠ€æœ¯æ¶æ„è®¾è®¡ã€‚ 